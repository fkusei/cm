---
- name: Add rails user
  user:
    name: media
    shell: /bin/bash
    home: /srv/media
    state: present

# TODO install goaccess
- copy: src=goaccess.sh
        dest=/usr/local/bin
        owner=root group=root mode=0755

- import_tasks: packages.yml
  tags: media-app

- template: src=postfix.conf
            dest=/etc/postfix/main.cf
            mode=0644 owner=root group=root

- import_tasks: rails-app.yml
  tags: media-app

- copy: src=redis.conf
        dest=/etc/redis/redis.conf
        owner=root group=root mode=0640

- import_tasks: nginx.yml
  tags:
    - nginx

- debug:
    msg:
      - "Manual steps:"
      - "upload voctoweb config files to /srv/media/media-site/shared"
      - "and create the gemset:"
      - "   rvm ruby-2.6.5 do rvm gemset create media-site"
      - ""
      - "create database, import data, etc.:"
      - "   sudo -u postgres pg_dump -F c -b -v -f file media-site"
      - "   sudo -u postgres createdb media-site"
      - "   sudo -u postgres pg_restore -d media-site -v file"
      - ""
      - "run capistrano:"
      - "   bundle exec cap app deploy"
      - "   bundle exec cap app elasticsearch:create_index"
      - "   bundle exec cap app elasticsearch:update"
      - ""
      - "optionally, modify profile of media user:"
      - "  .bashrc: cd media-site/shared"
      - "  .bash_profile: export RAILS_ENV=production"
